<script>
  function removeIllegalCharacters(string, variation = false) {
    if (variation) {
      return string.replace(/[\. ~\^\[\]]/g, '-');
    }
    return string.replace(/[\.\/ ~\^\[\]]/g, '-');
  }

  // TODO
  function validateRequest ({ episodeÂ }) {
    if (!episode) {
      writeFeedback('Missing episode name.', 'validation')
      return false
    }

    return true;
  }

  function readResponse (response, expectedStatus) {
    if (response.status !== expectedStatus) return readResponseError(response);
    return response.json();
  }

  function readResponseError ({ status, statusText}) {
    writeFeedback(`Error ${status}: ${statusText}`, 'error')
    return { error: true, status, statusText }
  }

  function writeFeedback (string, status) {
    console.log(string)
    document.getElementById('feedback').innerHTML = string;
  }

  function extractSha (json) {
    const { sha } = json;
    return sha;
  }

  function extractTreeUrl (json) {
    const { tree } = json;
    const { url } = tree;
    return url;
  }

  function extractTree (json) {
    const { tree } = json;
    return tree;
  }

  function createTextFile ({ branch, episode, permalink, podcast, description, link, media }) {
    return {
      path: `_podcasts/${branch}.md`,
      type: 'blob',
      mode: '100644',
      content:
      `---
      episode: ${episode}
      permalink: ${permalink}
      podcast: ${podcast}
      image: .jpg
      description: ${description}
      link: ${link}
      media: ${media}
      ---`.replace(/            /g, ''),
    }
  }

  function createImage ({ image, podcast, episode }) {
    if (!image) return null;
    return null
  }

  async function createPullRequest (event = undefined) {
    if (event) {
      event.preventDefault();      
    }
    const episode = document.getElementById('episode').value;
    const slug = document.getElementById('permalink').value;
    const podcast = document.getElementById('podcast').value;
    const description = document.getElementById('description').value;
    const link = document.getElementById('link').value;
    const media = document.getElementById('media').value;
    const image = document.getElementById('image').value;
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    const branch = removeIllegalCharacters(episode);
    const permalink = removeIllegalCharacters(slug, true);
    const credentials = btoa(`${username}:${password}`);

    const data = {
      episode,
      permalink,
      podcast,
      description,
      link,
      media,
      image,
      branch,
      username,
      password,
      credentials,
    };
    console.log({data});

    if (!validateRequest(data)) return;

    const authHeaders = {
      headers: {
        Authorization: `Basic ${credentials}`,
      }
    };

    function fetchWithAuth (url, options = {}) {
      return fetch(url, {...options, ...authHeaders})
    }

    // fetch head
    const fetchHead = await fetchWithAuth('{{ site.github_api }}/git/refs/heads/master')
      .then(response => readResponse(response, 200))
      .catch(error => writeFeedback(`Error: ${error.message}`));

    if (fetchHead.error) return;

    const commitId = extractSha(fetchHead.object);
    console.log(`Fetched last commit to master: ${commitId}.`)

    // fetch commit
    const fetchCommitDetails = await fetchWithAuth(`{{ site.github_api }}/git/commits/${commitId}`)
      .then(response => readResponse(response, 200))
      .catch(error => writeFeedback(`Error: ${error.message}`));

    if (fetchCommitDetails.error) return;

    const treeUrl = extractTreeUrl(fetchCommitDetails);
    console.log(`Fetched tree URL of the commit: ${treeUrl}.`)

    // fetch tree
    const fetchTree = await fetchWithAuth(`${treeUrl}`)
      .then(response => readResponse(response, 200))
      .catch(error => writeFeedback(`Error: ${error.message}`));

    if (fetchTree.error) return;

    const rootFolderId = extractSha(fetchTree);
    console.log('Fetched SHA of the root tree of the commit:', rootFolderId)

    // create branch
    const createBranch = await fetchWithAuth('{{ site.github_api }}/git/refs', {
      method: 'post',
      body: JSON.stringify({
        ref: `refs/heads/${branch}`,
        sha: commitId,
      }),
    })
      .then(response => readResponse(response, 201))
      .catch(error => writeFeedback(`Error: ${error.message}`));

    if (createBranch.error) return;
    console.log(`Created branch: ${branch}.`)

    // create tree
    const newTree = [
      ...createTextFile(data),
      ...createImage(data),
    ];
    const createTree = await fetchWithAuth('{{ site.github_api }}/git/trees', {
      method: 'post',
      body: JSON.stringify({
        base_tree: rootFolderId,
        tree: newTree.filter(entry => entry !== null),
      }),
    })
      .then(response => readResponse(response, 201))
      .catch(error => writeFeedback(`Error: ${error.message}`));

    if (createTree.error) return;
    const newTreeSha = extractSha(createTree);
    console.log(`Created new tree: ${newTreeSha}`)

    // commit changes
    console.log('POST {{ site.github_api }}/git/commits');
    const createCommit = await fetchWithAuth('{{ site.github_api }}/git/commits', {
      method: 'post',
      body: JSON.stringify({
        message: `${podcast} - ${episode}`,
        tree: newTreeSha,
        parents: [commitId],
      }),
    })
      .then(response => readResponse(response, 201))
      .catch(error => writeFeedback(`Error: ${error.message}`));

    if (createCommit.error) return;
    const newCommitId = extractShaFromBlob(createCommit);
    console.log(`Changes committed to ${branch}.`)

    // push
    const pushChanges = await fetchWithAuth(`{{ site.github_api }}/git/refs/heads/${branch}`, {
      method: 'post',
      body: JSON.stringify({
        sha: newCommitId,
      }),
    })
      .then(response => readResponse(response, 200))
      .catch(error => writeFeedback(`Error: ${error.message}`));

    if (pushChanges.error) return;
    console.log(`Pushed commit to ${branch}!`)

    // create PR

    // fetch("{{ site.github_api }}/pulls")

    return true;
  }

  document.getElementById('create-pull-request').addEventListener('submit', function(event) {
    event.preventDefault();
    createPullRequest(event);
  }, false);

</script>